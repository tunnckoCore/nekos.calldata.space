<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Neko â€” Single SVG with separate colorable parts</title>
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <style>
            :root {
                --red: oklch(0.63 0.3 25);
                --orange: oklch(0.72 0.28 55);
                --yellow: oklch(0.87 0.22 95);
                --lime: oklch(0.84 0.27 120);
                --green: oklch(0.79 0.3 145);
                --emerald: oklch(0.75 0.25 170);
                --teal: oklch(0.7 0.21 180);
                --cyan: oklch(0.78 0.2 200);
                --sky: oklch(0.8 0.18 220);
                --blue: oklch(0.55 0.33 260);
                --indigo: oklch(0.5 0.31 275);
                --violet: oklch(0.6 0.32 295);
                --purple: oklch(0.55 0.3 310);
                --fuchsia: oklch(0.65 0.34 330);
                --pink: oklch(0.75 0.24 5);
                --rose: oklch(0.68 0.26 15);
                --white: oklch(98.4% 0.003 247.858);
                --black: oklch(14.7% 0.004 49.25);

                --neko-background: var(--sky);
                --neko-ground: oklch(
                    from var(--neko-background) calc(l * 0.75) c h
                );
                --neko-left-eye: var(--red);
                --neko-right-eye: var(--red);
                --neko-mouth: var(--red);
                --neko-head: var(--yellow);
                --neko-body: var(--yellow);
                --neko-tail: var(--yellow);
                --neko-leg-1: var(--yellow);
                --neko-leg-2: var(--yellow);
                --neko-leg-3: var(--yellow);
                --neko-leg-4: var(--yellow);
            }

            .grid {
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                align-items: center;
                justify-content: center;
                /*height: 100vh;*/
                width: 100vw;
                gap: 1rem;
            }

            .grid-item {
                width: 150px;
                height: 150px;
            }
        </style>
    </head>
    <body>
        <div class="grid"></div>
        <template id="neko-template">
            <svg
                viewBox="0 0 150 150"
                xmlns="http://www.w3.org/2000/svg"
                role="img"
                aria-label="0xNeko SVG"
            >
                <!-- SKY -->
                <rect
                    x="0"
                    y="0"
                    width="100%"
                    height="100%"
                    fill="var(--neko-background)"
                />

                <!-- GROUND -->
                <rect
                    x="0"
                    y="115"
                    width="100%"
                    height="35"
                    fill="var(--neko-ground)"
                />

                <!-- BODY -->
                <path
                    fill="var(--neko-body)"
                    d="M105,98 L45,98 L45,84.5 L48.333,84.5 L48.333,81.75 L51.667,81.75 L51.667,78 L94.667,78 L94.667,81.75 L101.333,81.75 L101.333,84.5 L105,84.5 L105,98z"
                />

                <!-- TAIL -->
                <polygon
                    fill="var(--neko-tail)"
                    points="96,85 96,82 93,82 93,76 90,76 90,64 93,64 93,58 96,58 96,55 99,55 99,52 105,52 105,58 102,58 102,61 99,61 99,64 96,64 96,76 99,76 99,79 102,79 102,82 105,82 105,88 99,88 99,85"
                />

                <!-- BACK LEGS -->
                <polygon
                    fill="var(--neko-leg-4)"
                    points="64.5,115 71,115 71,111.656 74.25,111.656 74.25,95 64.5,95"
                />
                <polygon
                    fill="var(--neko-leg-3)"
                    points="93.5,115 100,115 100,111.656 103.25,111.656 103.25,95 93.5,95"
                />

                <!-- FRONT LEGS -->
                <polygon
                    fill="var(--neko-leg-2)"
                    points="79,115 85.5,115 85.5,111.656 88.75,111.656 88.75,95 79,95"
                />
                <polygon
                    fill="var(--neko-leg-1)"
                    points="45,115 51.5,115 51.5,111.656 54.75,111.656 54.75,95 45,95"
                />

                <!-- LEFT EYE BAND - shows through left eye cutout in head -->
                <!-- Left eye cutout in head path: x=42.66 to 45.88, y=68.738 to 75.393 -->
                <rect
                    x="42.66"
                    y="68.738"
                    width="4"
                    height="8"
                    fill="var(--neko-left-eye)"
                />

                <!-- RIGHT EYE BAND - shows through right eye cutout in head -->
                <!-- Right eye cutout in head path: x=68.33 to 71.55, y=68.738 to 75.393 -->
                <rect
                    x="68.33"
                    y="68.738"
                    width="4"
                    height="8"
                    fill="var(--neko-right-eye)"
                />

                <!-- MOUTH BAND - shows through mouth cutout in head -->
                <!-- Mouth cutout in head path: x=52.33 to 61.91, y=78.475 to 81.721 -->
                <rect
                    x="52.33"
                    y="78.475"
                    width="10"
                    height="4"
                    fill="var(--neko-mouth)"
                />

                <!-- HEAD PATH - with cutouts for left eye, right eye, and mouth -->
                <path
                    fill="var(--neko-head)"
                    d="M42.66,75.393 L45.88,75.393 L45.88,68.738 L42.66,68.738 L42.66,75.393z M61.91,81.721 L61.91,78.475 L52.33,78.475 L52.33,81.721 L61.91,81.721z M71.55,68.738 L68.33,68.738 L68.33,75.393 L71.55,75.393 L71.55,75.393z M39.44,85.295 L39.44,81.721 L36.22,81.721 L36.22,78.475 L33,78.475 L33,62.082 L36.22,62.082 L36.22,55.361 L39.44,55.361 L39.44,48.689 L42.66,48.689 L42.66,45.328 L45.88,45.328 L45.88,48.689 L49.11,48.689 L49.11,52.016 L52.33,52.016 L52.33,55.361 L61.91,55.361 L61.91,52.016 L65.13,52.016 L65.13,48.689 L68.33,48.689 L68.33,45.328 L71.55,45.328 L71.55,48.689 L74.77,48.689 L74.77,55.361 L77.99,55.361 L77.99,62.082 L81.21,62.082 L81.21,78.475 L77.99,78.475 L77.99,81.721 L74.77,81.721 L74.77,85.295 L39.44,85.295z"
                />

                <!-- EMOJI -->
                <foreignObject x="15" y="85" width="20" height="20">
                    <div xmlns="http://www.w3.org/1999/xhtml">ðŸ§¶</div>
                </foreignObject>
            </svg>
        </template>
        <script type="module">
            import Color from "https://colorjs.io/dist/color.js";

            const allCursors = [
                { name: "mouse", emoji: "ðŸ­" },
                { name: "rabbit", emoji: "ðŸ‡" },
                { name: "fish", emoji: "ðŸŸ" },
                { name: "blowfish", emoji: "ðŸ¡" },
                { name: "shark", emoji: "ðŸ¦ˆ" },
                { name: "octopus", emoji: "ðŸ™" },
                { name: "steak", emoji: "ðŸ¥©" },
                { name: "cheese", emoji: "ðŸ§€" },
                { name: "snake", emoji: "ðŸ" },
                { name: "pretzel", emoji: "ðŸ¥¨" },
                { name: "lobster", emoji: "ðŸ¦ž" },
                { name: "yarn", emoji: "ðŸ§¶" },
                { name: "pineapple", emoji: "ðŸ" },
                { name: "banana", emoji: "ðŸŒ" },
                { name: "pear", emoji: "ðŸ" },
                { name: "crab", emoji: "ðŸ¦€" },
                { name: "shrimp", emoji: "ðŸ¦" },
                { name: "eggplant", emoji: "ðŸ†" },
                { name: "cucumber", emoji: "ðŸ¥’" },
                { name: "popcorn", emoji: "ðŸ¿" },
                { name: "cheese wedge", emoji: "ðŸ§€" },
                { name: "ear of corn", emoji: "ðŸŒ½" },
                { name: "tropical fish", emoji: "ðŸ " },
                { name: "oyster", emoji: "ðŸ¦ª" },
                { name: "grapes", emoji: "ðŸ‡" },
                { name: "bacon", emoji: "ðŸ¥“" },
                { name: "watermelon", emoji: "ðŸ‰" },
                { name: "squid", emoji: "ðŸ¦‘" },
                { name: "fish cake", emoji: "ðŸ¥" },
                { name: "peach", emoji: "ðŸ‘" },
                { name: "sushi", emoji: "ðŸ£" },
                { name: "tangerine", emoji: "ðŸŠ" },
                { name: "mango", emoji: "ðŸ¥­" },
                { name: "cut of meat", emoji: "ðŸ¥©" },
                { name: "fried shrimp", emoji: "ðŸ¤" },
                { name: "meat on bone", emoji: "ðŸ–" },
                { name: "milk", emoji: "ðŸ¥›" },
                { name: "sausage", emoji: "ðŸŒ­" },
                { name: "tuna", emoji: "ðŸŸ" },
                { name: "salmon", emoji: "ðŸŸ" },
                { name: "rubberduck", emoji: "ðŸ¦†" },
            ];

            const cursorMap = Object.fromEntries(
                allCursors.map((c) => [c.name, c.emoji]),
            );

            export function isValidColor(color) {
                try {
                    new Color(color);
                    return true;
                } catch {
                    return false;
                }
            }

            function getColor(item, type) {
                const isValid = isValidColor(item.traits[type]);
                const patchColor = new Color(item.extractedColors[type])
                    .to("oklch")
                    .toString();

                const traitColor = isValid
                    ? new Color(item.traits[type]).to("oklch").toString()
                    : patchColor;

                if (isValid) {
                    return traitColor !== patchColor ? patchColor : traitColor;
                }

                return patchColor;
            }
            function getProperColors(item) {
                return {
                    cat: getColor(item, "cat"),
                    eyes: getColor(item, "eyes"),
                    background: getColor(item, "background"),
                };
            }

            // Generate random OKLCH color with specified lightness
            function generateOKLCHColor(lightness) {
                // If no lightness provided, randomize between 30-90%
                if (lightness === undefined) {
                    lightness = 50 + Math.random() * 70;
                }

                let chroma;

                while (chroma === undefined || chroma < 0.2 || chroma > 0.35) {
                    chroma = Math.random();
                }

                const hue = Math.floor(Math.random() * 360);
                const color = `oklch(${lightness}% ${chroma} ${hue})`;
                return color;
            }

            // Generate random neko with WCAG21 compliant colors
            function generateRandomNeko(index) {
                let bgColor, catColor, eyesColor;
                let contrast = 0;

                // Keep generating colors until we get WCAG21 AA compliant contrast (4.5:1)
                let attempts = 0;
                while (contrast < 4.5 && attempts < 100) {
                    bgColor = generateOKLCHColor();
                    catColor = generateOKLCHColor();

                    // Check contrast using colorjs
                    const bg = new Color(bgColor);
                    const cat = new Color(catColor);
                    contrast = bg.contrastWCAG21(cat);
                    attempts++;
                }

                // Generate eye color
                eyesColor = generateOKLCHColor();

                // Random cursor from the list
                const randomCursor =
                    allCursors[Math.floor(Math.random() * allCursors.length)];

                return {
                    sequence: `random-${index}`,
                    traits: {
                        background: bgColor,
                        cat: catColor,
                        eyes: eyesColor,
                        cursor: randomCursor.name,
                        gen: "random",
                    },
                    extractedColors: {
                        background: bgColor,
                        cat: catColor,
                        eyes: eyesColor,
                    },
                };
            }

            // Fetch and render nekos
            async function loadNekos() {
                try {
                    // Generate 1000 random nekos
                    console.log("Generating random nekos...");
                    const randomNekos = Array.from({ length: 12 }, (_, i) =>
                        generateRandomNeko(i + 1),
                    );

                    const response = await fetch(
                        "http://localhost:5173/0xnekos.json",
                    );
                    const json = await response.json();
                    const fetchedNekos = json.data.filter(
                        (neko) =>
                            neko.traits.gen.toLowerCase().includes("og") ||
                            neko.traits.gen.toLowerCase().includes("eths"),
                    );

                    // Prepend random nekos to fetched ones
                    const nekos = [...fetchedNekos];

                    console.log(
                        `Total: ${nekos.length} nekos (${randomNekos.length} random + ${fetchedNekos.length} fetched)`,
                    );

                    const grid = document.querySelector(".grid");
                    const template = document.querySelector("#neko-template");

                    nekos.forEach((neko, index) => {
                        const svgTemplate = template.content.cloneNode(true);
                        const gridItem = document.createElement("div");
                        gridItem.classList.add("grid-item");
                        gridItem.title = `Sequence ${neko.sequence} / ${index + 1}`;
                        gridItem.dataset.filename = `neko-${neko.sequence}-${index + 1}.png`;

                        // Get the actual SVG element from the cloned content
                        const item = svgTemplate.querySelector("svg");

                        // Set CSS variables for this specific cat
                        const colors = getProperColors(neko);

                        const ground = new Color(colors.background);

                        item.style.setProperty(
                            "--neko-background",
                            colors.background,
                        );
                        item.style.setProperty(
                            "--neko-ground",
                            ground.darken(0.4).toString(),
                        );
                        item.style.setProperty("--neko-face", colors.eyes);
                        item.style.setProperty("--neko-cat", colors.cat);

                        item.style.setProperty(
                            "--neko-left-eye",
                            `var(--neko-face)`,
                        );
                        item.style.setProperty(
                            "--neko-right-eye",
                            `var(--neko-face)`,
                        );
                        item.style.setProperty(
                            "--neko-mouth",
                            `var(--neko-face)`,
                        );
                        item.style.setProperty(
                            "--neko-head",
                            `var(--neko-cat)`,
                        );
                        item.style.setProperty(
                            "--neko-body",
                            `var(--neko-cat)`,
                        );
                        item.style.setProperty(
                            "--neko-tail",
                            `var(--neko-cat)`,
                        );
                        item.style.setProperty(
                            "--neko-leg-1",
                            `var(--neko-cat)`,
                        );
                        item.style.setProperty(
                            "--neko-leg-2",
                            `var(--neko-cat)`,
                        );
                        item.style.setProperty(
                            "--neko-leg-3",
                            `var(--neko-cat)`,
                        );
                        item.style.setProperty(
                            "--neko-leg-4",
                            `var(--neko-cat)`,
                        );

                        // Set emoji from cursor trait
                        const emojiText =
                            item.querySelector("foreignObject div");
                        if (emojiText) {
                            emojiText.textContent =
                                cursorMap[neko.traits.cursor];
                        }

                        gridItem.appendChild(item);
                        grid.appendChild(gridItem);
                    });

                    console.log(`Loaded ${nekos.length} nekos`);
                } catch (error) {
                    console.error("Error loading nekos:", error);
                }
            }

            // Load nekos on page load
            loadNekos();
        </script>
        <script type="module">
            // Snapdom is fast and cool, but the colors of the svg fill are not respected
            import { snapdom } from "https://unpkg.com/@zumer/snapdom/dist/snapdom.mjs";
            import domToImageMore from "https://esm.sh/dom-to-image-more@3.2.0";
            const snapshotter = snapdom;

            // Optional: Add click handler for individual cats to download
            document.addEventListener("click", async (e) => {
                const container = e.target.closest(".grid-item");
                if (container) {
                    console.log({ svg: container.outerHTML });
                    const res = await snapshotter.download(container, {
                        width: 150,
                        height: 150,
                        filename: container.dataset.filename,
                        format: "png",
                    });
                }
            });
        </script>
    </body>
</html>
